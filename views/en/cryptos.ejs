<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cryptos</title>
    <script type="text/javascript" src="/javascripts/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="/javascripts/utils.js"></script>
    <link rel='stylesheet' id="theme" href='/stylesheets/style.css'/>
    <link rel='stylesheet' href='/stylesheets/cryptos.css'/>
</head>
<body>

<form id="form">
    <div id="container" class="container">
        <div w3-include-html="/html/en/header.html"></div>
        <div class="message">
            <span id="message">Load of cryptos in progress...</span>
        </div>
        <div class="filter cond">
            <input class="input" type="text" id="criteria" placeholder="Filter">
            <button type="button" class="button button-filter" onclick="doFilter('all');">Filter all</button>
            <button type="button" class="button button-filter" onclick="doFilter('symbol');">Symbol filter</button>
            <button type="button" class="button button-filter" onclick="resetFilter();">Remove filter
            </button>
        </div>
        <div class="subcontainer">
            <div id="myCryptos">
                <div class="title-table"><span>My cryptos</span></div>
                <table id="myCryptosTable" class="styled-table">
                    <thead>
                    <th>Id</th>
                    <th>Symbol</th>
                    <th>Name</th>
                    <th></th>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="button-box">
                    <input class="button" type="button" onclick="changeButtonList(this);return false;"
                           name="buttonList" id="buttonList" value="Show available cryptos">
                </div>
            </div>
            <div id="availableCryptos" class="bloc cond">
                <div class="title-table"><span>Cryptos available</span></div>
                <div class="bloc">
                    <table id="availableCryptosTable" class="styled-table ctable">
                        <thead>
                        <th></th>
                        <th>Id</th>
                        <th>Symbol</th>
                        <th>Name</th>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</form>

<script src="/javascripts/cryptos.js"></script>

<script>

    let addMyCryptosRow = (row) => {
        let infoHtml = getInfoIconHtml(row);
        let r = `<tr><td>${infoHtml}</td><td>${getTokenIconHtml(row)}</td><td>${row.id}</td><td>${row.symbol}</td><td>${row.name}</td><td class="action" ` +
            `onclick="suppressMyCrypto(this)"><span class="indic-moins" title="Remove from my cryptos">-</span></td></tr>`
        $('#myCryptosTable').append(r);
    }

    let addAvailableCryptosRow = async (row) => {
        let r = `<tr><td class="action" onclick="addMyCrypto(this)"><span class="indic-plus" ` +
            `title="Add to my cryptos">+</span></td><td id="id">${row.id}</td><td id="symbol">${row.symbol}</td>` +
            `<td id="name">${row.name}</td></tr>`
        $('#availableCryptosTable').append(r);
    }

    let changeButtonList = (o) => {
        if (availableCryptoShown === true) {
            o.value = "Show available cryptos";
            availableCryptoShown = false;
            $('.cond').hide();
        } else {
            buildAvailableCryptos(true).then(() => {
                o.value = "Hide available cryptos";
                availableCryptoShown = true;
                $('.cond').show();
            })
        }
    }

    let addMyCrypto = (o) => {
        let children = o.closest("tr").children;
        let crypto = {"id": children[1].innerText, "symbol": children[2].innerText, "name": children[3].innerText}
        let index = getIndexInArray(availableCryptosList, crypto);
        if (index >= 0) {
            availableCryptosList.splice(index, 1);
            myCryptosList.push(crypto);
            addToCollection(JSON.stringify(crypto)).then((data) => {
                buildAvailableCryptos(false).then(() => {
                    buildMyCryptos();
                    alert(`Crypto ${crypto.name} added`)
                })
            }).fail((error) => {
                console.log(error)
            });
        } else {
            alert("Error. Item does not exists in availableCryptos")
        }
    }

    let suppressMyCrypto = (o) => {
        let children = o.closest("tr").children;
        let crypto = {"id": children[0].innerText, "symbol": children[1].innerText, "name": children[2].innerText}
        let indexAvailable = getIndexInArray(availableCryptosList, crypto);
        let indexMy = getIndexInArray(myCryptosList, crypto);
        if (indexAvailable >= 0) {
            alert("Error. Item already exists in myCryptos : " + JSON.stringify(availableCryptosList[indexAvailable]));
        } else {
            myCryptosList.splice(indexMy, 1);
            removeFromCollection(crypto).then((data) => {
                buildAvailableCryptos(true).then(() => {
                    buildMyCryptos();
                })
            }).fail((error) => {
                console.log(error)
            });
        }
    }

    $(() => {
        init()
    })

</script>
</body>
</html>